import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot } from 'firebase/firestore';
import { Flame, ChevronRight, ChevronLeft, LayoutDashboard, Timer, Activity, Save, CheckCircle2 } from 'lucide-react';

// --- CONFIGURACIÓN FIREBASE ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'fst7-elite-app';

export default function App() {
    const [user, setUser] = useState(null);
    const [view, setView] = useState('home');
    const [selectedMuscle, setSelectedMuscle] = useState(null);
    const [timerActive, setTimerActive] = useState(false);
    const [timeLeft, setTimeLeft] = useState(30);
    const [currentSet, setCurrentSet] = useState(1);
    const [history, setHistory] = useState({});
    
    const timerRef = useRef(null);

    // 1. Autenticación (Regla 3: Auth antes que nada)
    useEffect(() => {
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };
        initAuth();
        const unsubscribe = onAuthStateChanged(auth, setUser);
        return () => unsubscribe();
    }, []);

    // 2. Cargar Progreso desde Firestore (Regla 1: Rutas estrictas)
    useEffect(() => {
        if (!user) return;
        
        // Usamos la ruta obligatoria para datos privados del usuario
        const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'progress', 'current');
        
        const unsubscribe = onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                // Cargamos el historial de músculos completados hoy
                setHistory(data.history || {});
            }
        }, (err) => {
            console.error("Error cargando datos de Firestore:", err);
        });

        return () => unsubscribe();
    }, [user]);

    // Función para guardar progreso en la nube
    const saveProgress = async (muscleId, isCompleted = false) => {
        if (!user) return;
        const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'progress', 'current');
        
        const today = new Date().toISOString().split('T')[0]; // Solo la fecha YYYY-MM-DD
        
        const newHistory = { ...history };
        if (isCompleted) {
            newHistory[muscleId] = today;
        }

        try {
            await setDoc(docRef, {
                history: newHistory,
                lastUpdate: new Date().toISOString()
            }, { merge: true });
        } catch (error) {
            console.error("Error al guardar en Firebase:", error);
        }
    };

    // Lógica del Temporizador (Sin sonido, solo visual y vibración)
    useEffect(() => {
        if (timerActive && timeLeft > 0) {
            timerRef.current = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
        } else if (timeLeft === 0) {
            setTimerActive(false);
            // Vibración al terminar (funciona en la mayoría de Androids)
            if (window.navigator.vibrate) {
                window.navigator.vibrate([300, 100, 300]);
            }
        }
        return () => clearTimeout(timerRef.current);
    }, [timerActive, timeLeft]);

    const startTimer = () => {
        setTimeLeft(30);
        setTimerActive(true);
    };

    const protocols = [
        { id: 'chest', title: 'Pecho', fst7: 'Pec Deck / Cruces' },
        { id: 'back', title: 'Espalda', fst7: 'Pullover Polea Alta' },
        { id: 'quads', title: 'Cuádriceps', fst7: 'Extensiones de Pierna' },
        { id: 'arms', title: 'Brazos', fst7: 'Curl / Extensiones' }
    ];

    const todayStr = new Date().toISOString().split('T')[0];

    return (
        <div className="min-h-screen bg-black text-white flex flex-col font-sans select-none overflow-hidden">
            {/* Header con Safe Area */}
            <header className="pt-14 p-6 border-b border-zinc-900 bg-zinc-950/80 backdrop-blur-md sticky top-0 z-50">
                <div className="flex justify-between items-center">
                    <div className="flex items-center gap-2">
                        <div className="bg-red-600 p-1.5 rounded-lg shadow-lg shadow-red-600/20">
                            <Flame className="w-5 h-5 text-white" fill="currentColor" />
                        </div>
                        <h1 className="text-xl font-black italic tracking-tighter uppercase italic">FST-7 <span className="text-red-600">Elite</span></h1>
                    </div>
                    {user && (
                        <div className="px-3 py-1 bg-zinc-900 rounded-full border border-zinc-800">
                            <p className="text-[9px] text-zinc-500 font-bold uppercase tracking-widest flex items-center gap-1">
                                <span className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Online
                            </p>
                        </div>
                    )}
                </div>
            </header>

            <main className="flex-1 p-5 pb-32 overflow-y-auto">
                {view === 'home' ? (
                    <div className="space-y-6 animate-in fade-in duration-500">
                        <div className="px-1">
                            <h2 className="text-zinc-500 font-black uppercase text-[10px] tracking-[0.3em] mb-1">Entrenamiento de Hoy</h2>
                            <p className="text-xs text-zinc-400">Progreso sincronizado con la nube.</p>
                        </div>
                        
                        <div className="grid gap-3">
                            {protocols.map(p => (
                                <button 
                                    key={p.id} 
                                    onClick={() => {setSelectedMuscle(p); setView('workout'); setCurrentSet(1); setTimerActive(false);}} 
                                    className="w-full bg-zinc-900/40 p-5 rounded-[2rem] border border-zinc-800 flex justify-between items-center active:scale-95 transition-all"
                                >
                                    <div className="flex flex-col items-start text-left">
                                        <span className="font-bold uppercase tracking-tight text-lg">{p.title}</span>
                                        {history[p.id] === todayStr ? (
                                            <span className="text-[10px] text-green-500 font-bold uppercase tracking-widest mt-1 flex items-center gap-1">
                                                <CheckCircle2 className="w-3 h-3" /> Completado hoy
                                            </span>
                                        ) : (
                                            <span className="text-[10px] text-zinc-600 font-bold uppercase tracking-widest mt-1">Pendiente</span>
                                        )}
                                    </div>
                                    <ChevronRight className={`w-6 h-6 ${history[p.id] === todayStr ? 'text-green-900' : 'text-zinc-800'}`} />
                                </button>
                            ))}
                        </div>
                    </div>
                ) : (
                    <div className="space-y-6 animate-in slide-in-from-right duration-300">
                        <button onClick={() => setView('home')} className="text-red-600 font-black text-[10px] uppercase tracking-[0.2em] flex items-center gap-2 py-2">
                            <ChevronLeft className="w-4 h-4" /> Volver al Inicio
                        </button>

                        <div className="bg-zinc-900/50 border border-zinc-800 p-8 rounded-[3.5rem] text-center shadow-2xl relative overflow-hidden">
                            <h3 className="text-3xl font-black uppercase mb-1 tracking-tighter italic leading-none">{selectedMuscle.fst7}</h3>
                            <p className="text-red-600 font-black text-[10px] uppercase tracking-[0.4em] mb-10">Protocolo de 7 Series</p>
                            
                            <div className="flex justify-center gap-2 mb-12">
                                {[1,2,3,4,5,6,7].map(s => (
                                    <div key={s} className={`w-10 h-10 rounded-full flex items-center justify-center font-black text-sm transition-all duration-300 ${
                                        s === currentSet ? 'bg-red-600 scale-110 shadow-xl shadow-red-600/40 text-white' : 
                                        s < currentSet ? 'bg-zinc-800 text-zinc-600' : 'border-2 border-zinc-800 text-zinc-800'
                                    }`}>
                                        {s}
                                    </div>
                                ))}
                            </div>

                            <div className="mb-14">
                                <div className={`text-[9rem] font-black tracking-tighter leading-none tabular-nums ${timerActive ? 'text-red-600 animate-pulse' : 'text-zinc-800'}`}>
                                    {timeLeft}
                                </div>
                                <p className="text-zinc-600 font-black uppercase text-[10px] tracking-[0.6em] mt-4">Segundos de Descanso</p>
                            </div>

                            <button 
                                onClick={() => { 
                                    if(currentSet < 7) { 
                                        const next = currentSet + 1;
                                        setCurrentSet(next); 
                                        startTimer(); 
                                    } else { 
                                        saveProgress(selectedMuscle.id, true);
                                        setView('home'); 
                                    } 
                                }} 
                                className="w-full bg-red-600 py-6 rounded-[2.2rem] font-black uppercase tracking-widest text-sm shadow-xl shadow-red-900/40 active:scale-95 transition-transform"
                            >
                                {timerActive ? 'Descansando...' : currentSet === 7 ? 'Completar Rutina' : 'Serie Finalizada'}
                            </button>
                        </div>
                    </div>
                )}
            </main>

            {/* Navbar Bottom Fija */}
            <nav className="fixed bottom-0 left-0 right-0 bg-black border-t border-zinc-900 pb-10 pt-4 flex justify-around px-8 z-50">
                <button onClick={() => setView('home')} className={`flex flex-col items-center gap-1 ${view === 'home' ? 'text-red-600' : 'text-zinc-700'}`}>
                    <LayoutDashboard className="w-6 h-6" />
                    <span className="text-[8px] font-bold uppercase tracking-widest">Inicio</span>
                </button>
                <div className="relative -top-8">
                    <button className="bg-red-600 w-16 h-16 rounded-3xl rotate-45 flex items-center justify-center shadow-2xl shadow-red-600/30 active:scale-90 transition-transform">
                        <Activity className="w-8 h-8 text-white -rotate-45" />
                    </button>
                </div>
                <button onClick={() => { if(selectedMuscle) setView('workout') }} className={`flex flex-col items-center gap-1 ${view === 'workout' ? 'text-red-600' : 'text-zinc-700'}`}>
                    <Timer className="w-6 h-6" />
                    <span className="text-[8px] font-bold uppercase tracking-widest">Reloj</span>
                </button>
            </nav>
        </div>
    );
}
